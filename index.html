<!DOCTYPE html>
<html>
  <body>
    <h1>Hello World</h1>
    <button id="mybutton">Click me</button>
    <canvas hidden id="canvas"></canvas> 
    <video id="video" playsinline autoplay></video> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.0.0-alpha.1/axios.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Require the peer dependencies of face-landmarks-detection. -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>

    <!-- You must explicitly require a TF.js backend if you're not using the TF.js union bundle. -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>

    <script type="text/javascript">
      var video = document.querySelector("#video");

      // Basic settings for the video to get from Webcam
      const constraints = {
        audio: false,
        video: {
          width: 475,
          height: 475,
        },
      };

      // This condition will ask permission to user for Webcam access
      if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices
          .getUserMedia(constraints)
          .then(function (stream) {
            video.srcObject = stream;
          })
          .catch(function (err0r) {
            console.log("Something went wrong!");
          });
      }

      function stop(e) {
        var stream = video.srcObject;
        var tracks = stream.getTracks();

        for (var i = 0; i < tracks.length; i++) {
          var track = tracks[i];
          track.stop();
        }
        video.srcObject = null;
      }
    </script>

    <script type="text/javascript">
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");

        var destinationCanvas = document.createElement("canvas");
        var destCtx = destinationCanvas.getContext("2d");

        destinationCanvas.height = 500;
        destinationCanvas.width = 500;

        destCtx.translate(video.videoWidth, 0);
        destCtx.scale(-1, 1);
        destCtx.drawImage(document.getElementById("canvas"), 0, 0);

    </script>

    <script>
      const model = faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh;
      const detectorConfig = {
        runtime: "mediapipe",
        solutionPath: "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh",
        // or 'base/node_modules/@mediapipe/face_mesh' in npm.
      };

      async function PrintInfo(image) {
        const detector = await faceLandmarksDetection.createDetector(
          model,
          detectorConfig
        );
        const estimationConfig = { flipHorizontal: false };
        let faces = await detector.estimateFaces(image, estimationConfig);
        return faces;
      }
      // console.log(PrintInfo(document.querySelector("img")))
      $(document).ready(function () {
        $("#mybutton").click(function () {
            var imag = new Image();
            imag.src =destinationCanvas.toDataURL();
          var result = PrintInfo(imag);
          var data = result.then((data) => {
            // console.log(JSON.stringify(data));
            // console.log(result);

            var sc = JSON.stringify({
              KeyPoints: data[0].keypoints,
              Boxes: data[0].box,
            });
            console.log(sc);
            fetch("https://localhost:44396/api/Python", {
              method: "POST",
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json",
              },
              body: sc,
            })
              .then((response) => console.log(response.json()))
              .catch((error) => console.error("Unable to add item.", error));
          });
          data;
        });
      });
    </script>
  </body>
</html>
